<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Extracting Data from Crates Published on crates.io</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Building</li><li class="chapter-item expanded "><a href="building.html"><strong aria-hidden="true">1.</strong> Compiling Qrates</a></li><li class="chapter-item expanded affix "><li class="part-title">Extractor</li><li class="chapter-item expanded "><a href="extractor_crates_io.html" class="active"><strong aria-hidden="true">2.</strong> Extracting Data from Crates Published on crates.io</a></li><li class="chapter-item expanded "><a href="extractor_private.html"><strong aria-hidden="true">3.</strong> Extracting Data from a Private Rust Project</a></li><li class="chapter-item expanded affix "><li class="part-title">Database</li><li class="chapter-item expanded "><a href="creating_database.html"><strong aria-hidden="true">4.</strong> Creating the Database</a></li><li class="chapter-item expanded "><a href="database_structure.html"><strong aria-hidden="true">5.</strong> Database Structure</a></li><li class="chapter-item expanded affix "><li class="part-title">Queries</li><li class="chapter-item expanded "><a href="queries_run_existing.html"><strong aria-hidden="true">6.</strong> Running Existing Queries</a></li><li class="chapter-item expanded "><a href="queries_add_new.html"><strong aria-hidden="true">7.</strong> Add a New Query</a></li><li class="chapter-item expanded affix "><li class="part-title">Analysis</li><li class="chapter-item expanded "><a href="analysis_jupyter.html"><strong aria-hidden="true">8.</strong> Analysing Query Results with Jupyter</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#extracting-data-from-crates-published-on-cratesio" id="extracting-data-from-crates-published-on-cratesio">Extracting Data from Crates Published on crates.io</a></h1>
<p>This section shows how to extract data from crates published on <a href="https://crates.io/">crates.io</a>.</p>
<p><strong>Warning:</strong> The extraction involves compiling the crates and, therefore, may result in running potentially malicious code on your system. Therefore, make sure to compile the code on a virtual machine or in some other throw-away environment.</p>
<p>This section assumes that you have already compiled Qrates. You can find the instructions how to do that <a href="building.html">here</a>.</p>
<h2><a class="header" href="#obtaining-the-list-of-packages" id="obtaining-the-list-of-packages">Obtaining the List of Packages</a></h2>
<p>The second step is to select the packages<sup class="footnote-reference"><a href="#package">1</a></sup> from which we want to extract the data. This list of packages should be stored in the file <code>CrateList.json</code>. For example, if you want to analyse the package <code>rand</code>, create <code>CrateList.json</code> with the following contents:</p>
<div class="footnote-definition" id="package"><sup class="footnote-definition-label">1</sup>
<p>A package uploaded on crates.io can contain several crates. For example, it is common for executables to be split into an executable crate and a library crate.</p>
</div>
<pre><code class="language-json">{
  &quot;creation_date&quot;: {
    &quot;secs_since_epoch&quot;: 1579271281,
    &quot;nanos_since_epoch&quot;: 847419904
  },
  &quot;crates&quot;: [
    {
      &quot;Package&quot;: {
        &quot;name&quot;: &quot;rand&quot;,
        &quot;version&quot;: &quot;0.7.3&quot;
      }
    }
  ]
}
</code></pre>
<p>If you want to analyse all packages on crates.io, you can rename <code>CrateList-all-2020-01-14.json</code> to <code>CrateList.json</code>. That file contains the latest versions of all packages that were published on crates.io on 2020-01-14. Please note that compiling all packages requires at least 1 TB of hard drive space and running queries on so large dataset may require up to 200 GB of RAM. The dataset <code>CrateList-top-200-2020-01-17.json</code> 200 packages that were the most downloaded on crates.io; this dataset should be analysable on a laptop with 8 GB of RAM.</p>
<p>You can also create the list with the latest versions of all packages by running the following command:</p>
<pre><code class="language-bash">cargo run --release -- init-all
</code></pre>
<h2><a class="header" href="#compiling-the-packages" id="compiling-the-packages">Compiling the Packages</a></h2>
<p><em>Note:</em> Instead of compiling yourself, you can also download the extracted data from <a href="https://doi.org/10.5281/zenodo.4026639">here</a>.</p>
<p>Qrates uses the <a href="https://github.com/rust-lang/rustwide/">Rustwide</a> library for compiling packages. Please see the Rustwide documentation for the system requirements; most importantly you need to have <a href="https://www.docker.com/">Docker</a> installed (you can find the installation instructions <a href="https://docs.docker.com/engine/install/">here</a>).</p>
<p>You can start the compilation as follows:</p>
<pre><code class="language-bash">mkdir ../workspace
cargo run --release -- compile
</code></pre>
<p>This command may fail with a permission error if the user does not have the necessary permissions to communicate with the Docker manager. In that case, use <code>sudo</code>:</p>
<pre><code class="language-bash">sudo $(which cargo) run --release -- compile
</code></pre>
<p>Attempting to compile all packages from crates.io on Lenovo ThinkPad T470p takes about a week. You can check how many packages already successfully compiled by running the following command:</p>
<pre><code class="language-bash">ls ../workspace/rust-corpus/*/success | wc -l
</code></pre>
<p><em>Note:</em> it is likely that the number of successfully compiled packages will be smaller than the one we reported in the paper because some of the packages were removed from crates.io in the meantime.</p>
<h2><a class="header" href="#checking-compilation-results" id="checking-compilation-results">Checking Compilation Results</a></h2>
<p>The overview of compilation errors can be seen by running the following command:</p>
<pre><code class="language-bash">cargo run --release -- check-compilation
</code></pre>
<p>It will print the statistics of how many crates failed to compile for some common reason, how many failed likely due to a bug in the extractor, and how many failed for yet unrecognised reason. It will also print 5 paths of each of the latter groups.</p>
<p><em>Note:</em> The classification is implemented in <code>manager/src/compilation_checks.rs</code>.</p>
<p>If you are using an older <code>CrateList</code>, it is very likely that many crates will fail to compile because their dependencies were removed from the registry (they were “yanked”). One workaround for this problem would be to fork <a href="https://github.com/rust-lang/crates.io-index">the crates.io registry</a> and then restore the removed crates by setting their <code>yanked</code> flag to <code>False</code>. It is also recommended to remove all package versions that are newer than the ones in the the crate list. Both these operations could be done by executing the following script from the root directory of the registry repository:</p>
<pre><code class="language-python">#!/usr/bin/python3

import json
import os

CRATE_LIST = '&lt;path-to&gt;/CrateList-all-2020-01-14.json'

def rewrite(path, package, versions):
    &quot;&quot;&quot;Rewrite the cargo registry entry for `package` to contain only
    the entries older than the one mentioned in `versions` and restore
    all yanked version.
    &quot;&quot;&quot;
    if package not in versions:
        # This package probably was published after we created the
        # crates list and, therefore, will not appear among
        # dependencies.
        return
    newest_version = versions[package]
    with open(os.path.join(path, package)) as fp:
        try:
            lines = fp.read().splitlines()
        except:
            print(path, package)
            raise
    with open(os.path.join(path, package), 'w') as fp:
        for line in lines:
            data = json.loads(line)
            if 'yanked' in data and data['yanked']:
                data['yanked'] = False
                json.dump(data, fp, separators=(',', ':'))
            else:
                fp.write(line)
            fp.write('\n')
            if data['vers'] == newest_version:
                break

def main():
    with open(CRATE_LIST) as fp:
        crates = json.load(fp)['crates']
        versions = dict(
            (crate['Package']['name'], crate['Package']['version'])
            for crate in crates
        )

    for root, dirs, files in os.walk('.'):
        if root != '.':
            for package in files:
                rewrite(root, package, versions)
        else:
            dirs.remove('.git')

if __name__ == '__main__':
    main()
</code></pre>
<p>The registry that matches <code>CrateList-all-2020-01-14.json</code> can be found <a href="https://github.com/vakaras/crates.io-index">here</a>. To try recompiling all failed packages with this registry, execute the following commands:</p>
<pre><code class="language-bash">cargo run --release -- check-compilation --delete-failures
cargo run --release -- compile --purge-build-dir --custom-cargo-registry https://github.com/vakaras/crates.io-index
</code></pre>
<h2><a class="header" href="#moving-extracted-data" id="moving-extracted-data">Moving Extracted Data</a></h2>
<p>Since the extraction phase has quite different technical requirements from the later phases, it is common to execute these phases on different machines. The following command can be used to move deduplicated extracted data to a new directory for easy transfer:</p>
<pre><code class="language-bash">cargo run --release -- move-extracted &lt;target-dir&gt;
</code></pre>
<p>The command sleeps for 20 seconds after it collects the list of files to move and performing the actual move to reduce the risk of moving half-written files.</p>
<p>It will also generate <code>files.json</code> files that are then used by one of the queries to select the builds for analysis. Please note that some packages (for example, <code>sheesy-cli-4.0.7</code> and <code>actix-net-0.3.0</code>) are empty when compiled with default features, which results in <code>files.json</code> being empty.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="building.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="extractor_private.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="building.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="extractor_private.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
